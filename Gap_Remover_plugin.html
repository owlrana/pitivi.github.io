<!DOCTYPE html>
<html lang="en">
<head>

<base href=".">

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>Creating Plugins for the Timeline</title>

<link rel="stylesheet" href="assets/css/custom_bootstrap.css" type="text/css">
<link rel="stylesheet" href="assets/css/bootstrap-toc.min.css" type="text/css">
<link rel="stylesheet" href="assets/css/frontend.css" type="text/css">
<link rel="stylesheet" href="assets/css/jquery.mCustomScrollbar.min.css">

<link rel="stylesheet" href="assets/css/prism.css" type="text/css">

<script src="assets/js/mustache.min.js"></script>
<script src="assets/js/jquery.js"></script>
<script src="assets/js/scrollspy.js"></script>
<script src="assets/js/bootstrap.js"></script>
<script src="assets/js/typeahead.jquery.min.js"></script>
<script src="assets/js/search.js"></script>
<script src="assets/js/isotope.pkgd.min.js"></script>
<script src="assets/js/compare-versions.js"></script>
<script src="assets/js/jquery.mCustomScrollbar.concat.min.js"></script>
<script src="assets/js/bootstrap-toc.min.js"></script>
<script src="assets/js/jquery.touchSwipe.min.js"></script>
<script src="assets/js/anchor.min.js"></script>
<script src="assets/js/tag_filtering.js"></script>
<script src="assets/js/language_switching.js"></script>

<script src="assets/js/lines_around_headings.js"></script>

<script src="assets/js/prism-core.js"></script>
<script src="assets/js/prism-autoloader.js"></script>
<script src="assets/js/prism_autoloader_path_override.js"></script>
<script src="assets/js/trie.js"></script>

<link rel="shortcut icon" href="assets/images/favicon.png">

</head>

<body class="no-script
" data-spy="scroll" data-target="#toc" data-offset="70">

<script>
$('body').removeClass('no-script');
</script>

<nav class="navbar navbar-fixed-top navbar-default" id="topnav">
	<div class="container-fluid">
		<div class="navbar-right">
			<a id="toc-toggle">
				<span class="glyphicon glyphicon-menu-right"></span>
				<span class="glyphicon glyphicon-menu-left"></span>
			</a>
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-wrapper" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<form action="" class="navbar-form pull-right" id="navbar-search-form">
                               <div class="form-group has-feedback">
                                       <input type="text" class="form-control input-sm" name="search" id="sidenav-lookup-field" placeholder="search" disabled>
				       <span class="glyphicon glyphicon-search form-control-feedback" id="search-mgn-glass"></span>
                               </div>
                        </form>
		</div>
		<div class="navbar-header">
			<a id="sidenav-toggle">
				<span class="glyphicon glyphicon-menu-right"></span>
				<span class="glyphicon glyphicon-menu-left"></span>
			</a>
			<a id="home-link" href="index.html" class="hotdoc-navbar-brand">
				<img src="assets/images/pitivi.svg" alt="Home">
			</a>
		</div>
		<div class="navbar-collapse collapse" id="navbar-wrapper">
			<ul class="nav navbar-nav" id="menu">
							</ul>
			<div class="hidden-xs hidden-sm navbar-text navbar-center">
				<p><b>The Pitivi Developer Documentation</b></p>
			</div>
		</div>
	</div>
</nav>

<main>
<div data-extension="core" data-hotdoc-in-toplevel="True" data-hotdoc-project="Pitivi-1.0" data-hotdoc-ref="Gap_Remover_plugin.html" class="page_container" id="page-wrapper">
<script src="assets/js/utils.js"></script>

<div class="panel panel-collapse oc-collapsed" id="sidenav" data-hotdoc-role="navigation">
	<script src="assets/js/navigation.js"></script>
	<script src="assets/js/sitemap.js"></script>
</div>

<div id="body">
	<div id="main">
				    <div id="page-description" data-hotdoc-source="Gap_Remover_plugin.md" data-hotdoc-role="main">
        <h1 id="creating-plugins-for-the-timeline">Creating Plugins for the Timeline</h1>
<p>In the previous tutorial, you have seen how to create a simple plugin such way it can be recognized and listed by the Pitivi Plugin Manager. In this section, you will see how to write plugins that modifies the Timeline behavior.</p>
<h1 id="gap-remover-plugin">Gap Remover plugin.</h1>
<p>We are going to create a plugin for learning purposes that removes gap between clips.
The plugin will add a button in the <em>Pitivi Timeline</em> toolbar. So when we select a bunch of clips and click that button, clips will be positioned together.</p>
<p><img src="images/Plugins_Gap_Remover-1.gif" alt=""></p>
<h2 id="1-creating-a-plugin-description-file">1. Creating a <strong>.plugin</strong> description file</h2>
<p>As we mentioned in the previous tutorial, you have to create a plugin description file. So create a file named <code>gap-remover.plugin</code> with the following content:</p>
<pre><code class="language-ini">[Plugin]
Name=Gap Remover
Description=Removes gaps between clips.
Authors=Example &lt;example@example.com&gt;
website=http://example.foo
Copyright=Copyright © Example

Loader=python3
Module=gap_remover
</code></pre>
<p><em>For a complete example of a plugin description file, see <a href="https://developer.gnome.org/libpeas/stable/PeasPluginInfo.html">PeasPluginInfo documentation</a>.</em></p>
<h2 id="2-adding-a-button-to-the-pitivi-timelines-toolbar">2. Adding a button to the Pitivi Timeline's toolbar</h2>
<p>In this step, we will add a button to the timeline's toolbar.</p>
<pre><code class="language-python">from gettext import gettext as _
from gi.repository import GObject
from gi.repository import Gtk
from gi.repository import Peas

class GapRemover(GObject.Object, Peas.Activatable):
    object = GObject.Property(type=GObject.Object)

    def __init__(self):
        GObject.Object.__init__(self)
        self.app = None
        self.remove_gap_button = None

    def do_activate(self):
        API = self.object
        self.app = API.app
        self.remove_gap_button = Gtk.ToolButton.new_from_stock(Gtk.STOCK_STRIKETHROUGH)
        self.remove_gap_button.set_tooltip_text(_("Remove gaps between clips"))

        toolbar = self.app.gui.timeline_ui.toolbar
        toolbar.add(self.remove_gap_button)
        self.remove_gap_button.show()

    def do_deactivate(self):
        self.app.gui.timeline_ui.toolbar.remove(self.remove_gap_button)
        self.remove_gap_button.destroy()
        self.app = None
</code></pre>
<p>The <code>do_activate</code> method is executed everytime we enable (or turn on the switch in the <em>Pitivi Plugin Manager</em> of that plugin). There we are adding a new button that for the moment does not do anything. When we turn off the plugin's switch, <code>do_deactivate</code> is called. Here we need to tell <em>Pitivi</em> that we want to remove the added button.</p>
<h2 id="3-writing-the-logic-that-removes-the-gaps">3. Writing the logic that removes the gaps</h2>
<p>We have a button, but it does not do anything. In order to get this button to perform some action we need to connect it to a signal. We achieve this with this following line:</p>
<p><code>self.remove_gap_button.connect("clicked", self.__remove_gaps_cb)</code></p>
<p>Of course, we need to add a new method <code>__remove_gaps_cb</code> to our class. It would look like this:</p>
<ul>
<li>
<strong>First part of</strong> <code>__remove_gap_cb</code>:</li>
</ul>
<pre><code class="language-python">    def __remove_gap_cb(self, unused_button):
        selection = self.app.gui.timeline_ui.timeline.selection
        clips = sorted(selection, key=lambda x : x.get_start())
        group = self.app.gui.timeline_ui.timeline.current_group
        group.ungroup(False)
</code></pre>
<p>First we get the current selected clips and <a href="https://wiki.python.org/moin/HowTo/Sorting#Key_Functions">sort them by</a> the time they start at. Once we have the selection, we shouldn't start to change the position (in the timeline) of the clips. We need to be sure that our clips does not belong to a <a href="https://lazka.github.io/pgi-docs/GES-1.0/classes/Group.html">GES.Group</a>, otherwise if we change the start of some clip that is in the group, the whole group may be moved and we do not want that. So we ungroup the group.</p>
<ul>
<li>
<strong>Second part of</strong> <code>__remove_gap_cb</code>:</li>
</ul>
<pre><code class="language-python">        for i, clip in enumerate(clips[1:]):
            previous_clip = clips[i]
            end = previous_clip.get_start() + previous_clip.get_duration()
            clip.set_start(end)
</code></pre>
<p>Now we have the clips ready to be positioned. In this method, we first take as a base the first clip (<em>previous_clip</em>) in the list and iterate over the resting clips. We calculate the time of <em>end</em> (there is no method get_end(), but it can be calculated by the addition of the <em>start</em> and <em>duration</em> of the clip). Then we tell the next <em>clip</em> that should start when the <em>previous cliṕ</em> ends. And that's it, then our base is the next clips and we repeat this process for all the resting clips in the list.</p>
<h2 id="4-full-code">4. Full code</h2>
<pre><code class="language-python">from gettext import gettext as _
from gi.repository import GObject
from gi.repository import Gtk
from gi.repository import Peas

class GapRemover(GObject.Object, Peas.Activatable):
    object = GObject.Property(type=GObject.Object)

    def __init__(self):
        GObject.Object.__init__(self)
        self.app = None
        self.remove_gap_button = None

    def do_activate(self):
        API = self.object
        self.app = API.app
        self.remove_gap_button = Gtk.ToolButton.new_from_stock(Gtk.STOCK_STRIKETHROUGH)
        self.remove_gap_button.set_tooltip_text(_("Remove gaps between clips"))
        self.remove_gap_button.connect("clicked", self.__remove_gap_cb)

        toolbar = self.app.gui.timeline_ui.toolbar
        toolbar.add(self.remove_gap_button)
        self.remove_gap_button.show()

    def do_deactivate(self):
        self.app.gui.timeline_ui.toolbar.remove(self.remove_gap_button)
        self.remove_gap_button.destroy()
        self.app = None

    def __remove_gap_cb(self, unused_button):
        selection = self.app.gui.timeline_ui.timeline.selection
        clips = sorted(selection, key=lambda x : x.get_start())
        group = self.app.gui.timeline_ui.timeline.current_group
        group.ungroup(False)

        for i, clip in enumerate(clips[1:]):
            previous_clip = clips[i]
            end = previous_clip.get_start() + previous_clip.get_duration()
            clip.set_start(end)
</code></pre>

    </div>
        




		
	</div>
	<div id="search_results">
		<p>The results of the search are</p>
	</div>
	<hr>
	<div id="footer">
		    

	</div>
</div>

<div id="toc-column">
	
		<div class="edit-button">
		<a href="https://gitlab.gnome.org/GNOME/pitivi/edit/master/docs/Gap_Remover_plugin.md" data-hotdoc-role="edit-button">Edit on GitLab</a>

	</div>
		<div id="toc-wrapper">
		<nav id="toc"></nav>
	</div>
</div>
</div>
</main>

</body>

<script src="assets/js/navbar_offset_scroller.js"></script>
</html>
